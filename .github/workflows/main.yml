name: Build_mt7981_rax3000m

on: 
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * 5'

jobs:
  Build_mt7981_rax3000m:
    runs-on: ubuntu-latest
    
    # 添加環境變數
    env:
      WORK_DIR: /mnt/openwrt
      CONFIG_DIR: /mnt/openwrt/config-files
    
    steps:
    # 1. 檢查可用磁盤
    - name: Check available disks
      run: |
        echo "可用磁盤空間:"
        df -h
        echo "磁盤列表:"
        lsblk
        
    # 2. 準備工作目錄
    - name: Prepare workspace
      run: |
        # 使用臨時目錄而不是 /mnt
        mkdir -p /tmp/openwrt-build
        echo "WORK_DIR=/tmp/openwrt-build" >> $GITHUB_ENV
        echo "CONFIG_DIR=/tmp/openwrt-build/config-files" >> $GITHUB_ENV
        
    # 3. 複製配置文件
    - name: Copy configuration files
      run: |
        mkdir -p ${{ env.CONFIG_DIR }}
        
        # 檢查當前倉庫是否有配置文件
        echo "檢查配置文件..."
        
        # 如果當前倉庫有 config 文件夾
        if [ -d "./config" ]; then
          echo "使用當前倉庫的配置文件"
          cp -r ./config/* ${{ env.CONFIG_DIR }}/
        # 如果文件在根目錄
        else
          for file in rax3000m.config diy1.sh diy2.sh; do
            if [ -f "./$file" ]; then
              echo "找到 $file"
              cp "./$file" ${{ env.CONFIG_DIR }}/
            else
              echo "警告: 未找到 $file"
              # 創建簡單的配置文件
              case $file in
                "rax3000m.config")
                  # 創建基本配置
                  cat > "${{ env.CONFIG_DIR }}/rax3000m.config" << 'EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_DEVICE_cmcc_rax3000m=y
EOF
                  ;;
                "diy1.sh")
                  cat > "${{ env.CONFIG_DIR }}/diy1.sh" << 'EOF'
#!/bin/bash
echo "執行 diy1.sh - 初始配置"
# 添加自訂源
# sed -i 's/src-git packages/# src-git packages/g' feeds.conf.default
# echo "src-git packages https://github.com/openwrt/packages.git" >> feeds.conf.default
EOF
                  chmod +x "${{ env.CONFIG_DIR }}/diy1.sh"
                  ;;
                "diy2.sh")
                  cat > "${{ env.CONFIG_DIR }}/diy2.sh" << 'EOF'
#!/bin/bash
echo "執行 diy2.sh - Feeds 後配置"
# 安裝額外包
# ./scripts/feeds install luci-app-adbyby-plus
EOF
                  chmod +x "${{ env.CONFIG_DIR }}/diy2.sh"
                  ;;
              esac
            fi
          done
        fi
        
        echo "配置文件準備完成:"
        ls -la ${{ env.CONFIG_DIR }}

    # 4. 初始化環境
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get install -yqq \
          build-essential \
          ccache \
          file \
          gawk \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          rsync \
          unzip \
          wget \
          zlib1g-dev
        
        # 安裝 OpenWRT 編譯所需套件
        sudo apt-get install -yqq \
          subversion \
          g++ \
          gcc \
          binutils \
          patch \
          bzip2 \
          flex \
          make \
          autoconf \
          automake \
          libtool \
          sed \
          bc \
          tar \
          bash \
          help2man \
          bison \
          gcc-multilib \
          g++-multilib
        
        # 設置時區
        sudo timedatectl set-timezone "Asia/Shanghai"
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'

    # 5. 克隆 OpenWRT 源碼
    - name: Clone OpenWRT source
      working-directory: ${{ env.WORK_DIR }}
      run: |
        git clone -b v24.10.5 --single-branch --depth=1 https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        
        # 複製並執行 diy1.sh
        if [ -f "${{ env.CONFIG_DIR }}/diy1.sh" ]; then
          cp -f "${{ env.CONFIG_DIR }}/diy1.sh" ./
          chmod +x ./diy1.sh
          ./diy1.sh
        else
          echo "警告: 未找到 diy1.sh"
        fi

    # 6. 更新和安裝 feeds
    - name: Update & Install feeds
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 複製並執行 diy2.sh
        if [ -f "${{ env.CONFIG_DIR }}/diy2.sh" ]; then
          cp -f "${{ env.CONFIG_DIR }}/diy2.sh" ./
          chmod +x ./diy2.sh
          ./diy2.sh
        else
          echo "警告: 未找到 diy2.sh"
        fi

    # 7. 配置編譯
    - name: Configuration
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        echo "開始配置..."
        
        # 使用配置文件
        if [ -f "${{ env.CONFIG_DIR }}/rax3000m.config" ]; then
          cp -f "${{ env.CONFIG_DIR }}/rax3000m.config" ./.config
          echo "使用自訂配置文件"
        else
          echo "錯誤: 未找到配置文件"
          exit 1
        fi
        
        make defconfig

    # 8-12. 保持原有步驟不變，但更新路徑...
    # 8. Download package
    - name: Download package
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        echo "磁盤空間使用情況:"
        df -h
        echo "開始下載套件..."
        make download -j$(nproc)
        # 清理過小的文件
        find dl -size -1024c -delete 2>/dev/null || true

    # 9. 編譯固件
    - name: Build firmware
      working-directory: ${{ env.WORK_DIR }}/openwrt
      timeout-minutes: 120
      run: |
        echo "開始編譯，使用 $(nproc) 個核心..."
        make -j$(nproc) || make -j1 V=s
        echo "編譯完成！"

    # 10. 生成發布名稱
    - name: Generate release info
      id: release_info
      run: |
        RELEASE_TAG=$(date +%Y%m%d%H%M%S)
        RELEASE_NAME="MzWrt-CMCC-RAX3000M-$(date +%Y%m%d)"
        echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
        echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT

    # 11. 準備固件文件
    - name: Prepare firmware files
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        TARGET_DIR="./bin/targets/mediatek/filogic"
        
        # 壓縮 packages 目錄
        if [ -d "$TARGET_DIR/packages" ]; then
          tar -czf "$TARGET_DIR/packages.tar.gz" -C "$TARGET_DIR" packages
          rm -rf "$TARGET_DIR/packages"
        fi
        
        # 重命名文件
        for file in "$TARGET_DIR"/openwrt*; do
          if [ -f "$file" ]; then
            new_name=$(echo "$file" | sed 's/openwrt/MzWrt/g')
            mv "$file" "$new_name"
            echo "重命名: $(basename "$file") -> $(basename "$new_name")"
          fi
        done
        
        echo "最終文件:"
        ls -la "$TARGET_DIR/"

    # 12. 上傳構件
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: CMCC-RAX3000M-MzWrt
        path: ${{ env.WORK_DIR }}/openwrt/bin/targets/mediatek/filogic/*.{bin,tar.gz}

    # 13. 創建發布（可選）
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ steps.release_info.outputs.name }}
        tag_name: ${{ steps.release_info.outputs.tag }}
        files: ${{ env.WORK_DIR }}/openwrt/bin/targets/mediatek/filogic/*.{bin,tar.gz}
        body: |
          CMCC RAX3000M OpenWRT 固件
          編譯時間: $(date)
          OpenWRT 版本: v24.10.5      run: |
        # 尝试克隆公开配置仓库
        if git clone https://github.com/mzwrt/config.git /tmp/mzwrt-config; then
          echo "Successfully cloned public config repository"
          sudo mv /tmp/mzwrt-config /mnt/openwrt/mzwrt-openwrt
        else
          echo "Warning: Failed to clone config repository"
          echo "You may need to manually prepare config files"
          mkdir -p /mnt/openwrt/mzwrt-openwrt
        fi

    # 3. Initialization environment
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get -yqq upgrade
        sudo apt-get -yqq full-upgrade
        sudo apt-get -yqq autoremove --purge
        sudo apt-get -yqq autoclean
        sudo apt-get -yqq clean
        sudo apt-get install -yqq dos2unix python3-netifaces libfuse-dev libnuma-dev libfdt-dev libtorrent-rasterbar-dev clang golang rustc cargo m4 babeltrace libunwind-dev texinfo binutils binutils-gold liblzma-dev libzstd-dev autoconf automake ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip
        sudo apt-get install -yqq cpanminus libfile-spec-perl build-essential python3-setuptools liblua5.1-0 libtool-bin libcrypto++-dev libpcre3 libpcre3-dev libpcre3 libpcre3-dev python3-pip python3-socks python3-socks python3-unidecode 
        sudo systemctl daemon-reload
        sudo timedatectl set-timezone "Asia/Shanghai"
        git config --global user.name 'GitHub Actions' && git config --global user.email 'actions@github.com'

    # 4. Clone source code
    - name: Clone source code
      working-directory: /mnt/openwrt
      env: 
        REPO_URL: https://github.com/openwrt/openwrt.git
        OPENWRT_VERSION: "v24.10.5"
        OPENWRT_DIR: "openwrt"
      run: |
        git clone -b $OPENWRT_VERSION --single-branch --depth=1 $REPO_URL $OPENWRT_DIR
        cd openwrt
        
        # 如果存在 diy1.sh 则执行
        if [ -f ../mzwrt-openwrt/diy1.sh ]; then
          cp -f ../mzwrt-openwrt/diy1.sh ./
          chmod +x ./diy1.sh && ./diy1.sh
        else
          echo "Warning: diy1.sh not found, skipping..."
        fi

    # 5. Update & Install feeds
    - name: Update & Install feeds
      working-directory: /mnt/openwrt/openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 如果存在 diy2.sh 则执行
        if [ -f ../mzwrt-openwrt/diy2.sh ]; then
          cp -f ../mzwrt-openwrt/diy2.sh ./
          chmod +x ./diy2.sh && ./diy2.sh 
        else
          echo "Warning: diy2.sh not found, skipping..."
        fi

    # 6. Configuration Customization
    - name: Configuration Customization - Build_mt7981_rax3000m
      working-directory: /mnt/openwrt/openwrt
      run: |
        echo "======================="
        echo "======================="
        echo "======================="

        # 如果存在配置文件则使用，否则使用默认配置
        if [ -f ../mzwrt-openwrt/rax3000m.config ]; then
          cp -f ../mzwrt-openwrt/rax3000m.config ./
          mv rax3000m.config .config
          make defconfig
        else
          echo "Warning: rax3000m.config not found"
          echo "Please configure manually with: make menuconfig"
          exit 1
        fi

    # 7. Download package
    - name: Download package
      working-directory: /mnt/openwrt/openwrt
      run: |
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -h
        echo "======================="
        make download -j16
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    # 8. Build firmware
    - name: Build firmware
      working-directory: /mnt/openwrt/openwrt
      run: |
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -h
        echo "======================="
        pwd
        echo "======================="
        make -j$(nproc) || make -j1 V=99
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -h
        echo "======================="
        du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 ./build_dir
        du -h --max-depth=1 ./bin
        echo "======================="

    # 9. Generate Tag & Release Name
    - name: Generate Tag & Release Name
      id: generate_name
      run: |
        time=$(date +%Y%m%d%H%M%S)
        release_tag="$time"
        release_name="MzWrt-CMCC-RAX3000M-$(date +%Y%m%d)"
        echo "RELEASE_TAG=$release_tag" >> $GITHUB_OUTPUT
        echo "RELEASE_NAME=$release_name" >> $GITHUB_OUTPUT

    # 10. Prepare Firmware
    - name: Prepare Firmware
      working-directory: /mnt/openwrt/openwrt
      run: |
        # 检查并压缩 packages 目录
        if [ -d ./bin/targets/mediatek/filogic/packages ]; then
          tar -czf ./bin/targets/mediatek/filogic/packages.tar.gz -C ./bin/targets/mediatek/filogic packages
        fi

        # 重命名文件：将所有以 "openwrt" 开头的文件名中的 "openwrt" 替换为 "MzWrt"
        find ./bin/targets/mediatek/filogic -type f -name "openwrt*" -exec bash -c '
          for file; do
            mv "$file" "${file//openwrt/MzWrt}"
          done
        ' bash {} +

        # 删除非 .bin 和 .tar.gz 文件
        if [ -d ./bin/targets/mediatek/filogic/packages ]; then
          # 排除 packages.tar.gz，删除其他内容
          find ./bin/targets/mediatek/filogic/packages -type f ! -name "*.bin" ! -name "*.tar.gz" -exec sudo rm -f {} +
          # 直接删除整个 packages 目录及其内容
          sudo rm -rf ./bin/targets/mediatek/filogic/packages
        fi
        echo "======================="

        echo "Release name: ${{ steps.generate_name.outputs.RELEASE_NAME }}"
        echo "======================="

        ls /mnt/openwrt/openwrt/bin/targets/mediatek/filogic
        echo "======================="

    # 11. Upload Artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: CMCC-RAX3000M-MzWrt
        path: /mnt/openwrt/openwrt/bin/targets/mediatek/filogic/*.{bin,tar.gz}

    # 12. Create Release (使用默认的 GITHUB_TOKEN)
    - name: Create Release
      # 只有当仓库有发布权限时才执行
      if: github.repository != ''
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ steps.generate_name.outputs.RELEASE_NAME }}
        tag_name: ${{ steps.generate_name.outputs.RELEASE_TAG }}
        body: |
          CMCC-RAX3000M NAND firmware
          
          Build Information:
          - Date: $(date)
          - OpenWRT Version: v24.10.5
          - Target: mediatek/filogic
        files: /mnt/openwrt/openwrt/bin/targets/mediatek/filogic/*.{bin,tar.gz}
