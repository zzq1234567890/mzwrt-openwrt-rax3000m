name: Build_mt7981_rax3000m

on: 
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * 5'

jobs:
  Build_mt7981_rax3000m:
    runs-on: ubuntu-latest
    
    # 添加環境變數
    env:
      WORK_DIR: /tmp/openwrt-build
      CONFIG_DIR: /tmp/openwrt-build/config-files
    
    steps:
    # 1. 檢查可用磁盤
    - name: Check available disks
      run: |
        echo "可用磁盤空間:"
        df -h
        echo "磁盤列表:"
        lsblk
        
    # 2. 準備工作目錄
    - name: Prepare workspace
      run: |
        # 使用臨時目錄
        mkdir -p ${{ env.WORK_DIR }}
        echo "工作目錄準備完成: ${{ env.WORK_DIR }}"
        
    # 3. 複製配置文件
    - name: Copy configuration files
      run: |
        mkdir -p ${{ env.CONFIG_DIR }}
        
        # 檢查當前倉庫是否有配置文件
        echo "檢查配置文件..."
        
        # 如果當前倉庫有 config 文件夾
        if [ -d "./config" ]; then
          echo "使用當前倉庫的配置文件"
          cp -r ./config/* ${{ env.CONFIG_DIR }}/
        # 如果文件在根目錄
        else
          for file in rax3000m.config diy1.sh diy2.sh; do
            if [ -f "./$file" ]; then
              echo "找到 $file"
              cp "./$file" ${{ env.CONFIG_DIR }}/
            else
              echo "警告: 未找到 $file"
              # 創建簡單的配置文件
              case $file in
                "rax3000m.config")
                  # 創建基本配置
                  cat > "${{ env.CONFIG_DIR }}/rax3000m.config" << 'EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_DEVICE_cmcc_rax3000m=y
EOF
                  ;;
                "diy1.sh")
                  cat > "${{ env.CONFIG_DIR }}/diy1.sh" << 'EOF'
#!/bin/bash
echo "執行 diy1.sh - 初始配置"
# 添加自訂源
# sed -i 's/src-git packages/# src-git packages/g' feeds.conf.default
# echo "src-git packages https://github.com/openwrt/packages.git" >> feeds.conf.default
EOF
                  chmod +x "${{ env.CONFIG_DIR }}/diy1.sh"
                  ;;
                "diy2.sh")
                  cat > "${{ env.CONFIG_DIR }}/diy2.sh" << 'EOF'
#!/bin/bash
echo "執行 diy2.sh - Feeds 後配置"
# 安裝額外包
# ./scripts/feeds install luci-app-adbyby-plus
EOF
                  chmod +x "${{ env.CONFIG_DIR }}/diy2.sh"
                  ;;
              esac
            fi
          done
        fi
        
        echo "配置文件準備完成:"
        ls -la ${{ env.CONFIG_DIR }}

    # 4. 初始化環境
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get install -yqq \
          build-essential \
          ccache \
          file \
          gawk \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          rsync \
          unzip \
          wget \
          zlib1g-dev
        
        # 安裝 OpenWRT 編譯所需套件
        sudo apt-get install -yqq \
          subversion \
          g++ \
          gcc \
          binutils \
          patch \
          bzip2 \
          flex \
          make \
          autoconf \
          automake \
          libtool \
          sed \
          bc \
          tar \
          bash \
          help2man \
          bison \
          gcc-multilib \
          g++-multilib \
          cpio \
          curl \
          findutils \
          gperf \
          lrzsz \
          ncurses-term \
          python3-setuptools \
          quilt \
          xz-utils
        
        # 設置時區
        sudo timedatectl set-timezone "Asia/Shanghai"
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'

    # 5. 克隆 OpenWRT 源碼
    - name: Clone OpenWRT source
      working-directory: ${{ env.WORK_DIR }}
      run: |
        git clone -b v24.10.5 --single-branch --depth=1 https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        
        # 複製並執行 diy1.sh
        if [ -f "${{ env.CONFIG_DIR }}/diy1.sh" ]; then
          cp -f "${{ env.CONFIG_DIR }}/diy1.sh" ./
          chmod +x ./diy1.sh
          ./diy1.sh
        else
          echo "警告: 未找到 diy1.sh"
        fi

    # 6. 更新和安裝 feeds
    - name: Update & Install feeds
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 複製並執行 diy2.sh
        if [ -f "${{ env.CONFIG_DIR }}/diy2.sh" ]; then
          cp -f "${{ env.CONFIG_DIR }}/diy2.sh" ./
          chmod +x ./diy2.sh
          ./diy2.sh
        else
          echo "警告: 未找到 diy2.sh"
        fi

    # 7. 配置編譯
    - name: Configuration
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        echo "開始配置..."
        
        # 使用配置文件
        if [ -f "${{ env.CONFIG_DIR }}/rax3000m.config" ]; then
          cp -f "${{ env.CONFIG_DIR }}/rax3000m.config" ./.config
          echo "使用自訂配置文件"
        else
          echo "錯誤: 未找到配置文件"
          exit 1
        fi
        
        make defconfig

    # 8. 下載套件
    - name: Download package
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        echo "磁盤空間使用情況:"
        df -h
        echo "開始下載套件..."
        make download -j$(nproc)
        # 清理過小的文件
        find dl -size -1024c -delete 2>/dev/null || true

    # 9. 編譯固件
    - name: Build firmware
      working-directory: ${{ env.WORK_DIR }}/openwrt
      timeout-minutes: 120
      run: |
        echo "磁盤空間使用情況:"
        df -h
        echo "當前目錄:"
        pwd
        echo "開始編譯，使用 $(nproc) 個核心..."
        make -j$(nproc) || make -j1 V=s
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -h
        echo "======================="
        du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 ./build_dir
        du -h --max-depth=1 ./bin
        echo "編譯完成！"

    # 10. 生成發布名稱
    - name: Generate release info
      id: release_info
      run: |
        RELEASE_TAG=$(date +%Y%m%d%H%M%S)
        RELEASE_NAME="MzWrt-CMCC-RAX3000M-$(date +%Y%m%d)"
        echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
        echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT

    # 11. 準備固件文件
    - name: Prepare firmware files
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        TARGET_DIR="./bin/targets/mediatek/filogic"
        
        # 檢查目錄是否存在
        if [ ! -d "$TARGET_DIR" ]; then
          echo "錯誤: 找不到目標目錄 $TARGET_DIR"
          exit 1
        fi
        
        echo "處理固件文件..."
        
        # 壓縮 packages 目錄
        if [ -d "$TARGET_DIR/packages" ]; then
          echo "壓縮 packages 目錄..."
          tar -czf "$TARGET_DIR/packages.tar.gz" -C "$TARGET_DIR" packages
          rm -rf "$TARGET_DIR/packages"
        fi
        
        # 重命名文件
        echo "重命名文件..."
        for file in "$TARGET_DIR"/openwrt*; do
          if [ -f "$file" ]; then
            new_name=$(echo "$file" | sed 's/openwrt/MzWrt/g')
            mv "$file" "$new_name"
            echo "重命名: $(basename "$file") -> $(basename "$new_name")"
          fi
        done
        
        # 刪除非必要文件
        echo "清理非必要文件..."
        find "$TARGET_DIR" -type f ! -name "*.bin" ! -name "*.tar.gz" ! -name "packages.tar.gz" ! -name "*.img" -delete 2>/dev/null || true
        
        echo "最終文件列表:"
        ls -la "$TARGET_DIR/"

    # 12. 上傳構件
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: CMCC-RAX3000M-MzWrt
        path: ${{ env.WORK_DIR }}/openwrt/bin/targets/mediatek/filogic/*
        retention-days: 7

    # 13. 創建發布（可選）
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ steps.release_info.outputs.name }}
        tag_name: ${{ steps.release_info.outputs.tag }}
        files: ${{ env.WORK_DIR }}/openwrt/bin/targets/mediatek/filogic/*.{bin,tar.gz,img}
        body: |
          CMCC RAX3000M OpenWRT 固件
          
          編譯信息:
          - 編譯時間: $(date)
          - OpenWRT 版本: v24.10.5
          - 目標平台: mediatek/filogic
          - 設備: CMCC RAX3000M
          
          注意事項:
          1. 請確保在刷機前備份原廠固件
          2. 刷機有風險，請謹慎操作
          3. 建議使用官方推薦的刷機方法
